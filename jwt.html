<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JWT 解码 & 签名验证工具 (自动发现)</title>
    
    <!-- 1. Bulma CSS 框架 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    
    <!-- 2. Alpine.js 轻量 JS 框架 -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- 3. Jose 库用于 JWT 签名验证 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jose/4.14.4/index.umd.min.js"></script>

    <style>
        /* 自定义样式，让工具更好用 */
        .container {
            max-width: 1200px;
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        .jwt-textarea {
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            min-height: 300px;
            word-break: break-all;
        }
        pre {
            white-space: pre-wrap; /* 自动换行 */
            word-wrap: break-word; /* 单词内换行 */
        }
    </style>
</head>
<body>

<section class="section">
    <div class="container" x-data="jwtTools()">
        <h1 class="title has-text-centered">JWT 解码 & 签名验证</h1>
        <p class="subtitle has-text-centered">支持从 Issuer 自动发现 JWKS URL</p>

        <div class="columns">
            <!-- 左侧：JWT 输入 -->
            <div class="column">
                <div class="field">
                    <label class="label">Encoded JWT</label>
                    <div class="control">
                        <textarea
                            class="textarea jwt-textarea"
                            placeholder="在此粘贴你的 JSON Web Token..."
                            rows="35"
                            x-model="jwtInput"
                            @input.debounce.250ms="decodeJwt"
                        ></textarea>
                    </div>
                </div>
            </div>

            <!-- 右侧：解码后信息 -->
            <div class="column">
                <label class="label">Decoded Token</label>
                <div class="box" x-show="decodedHeader">
                    <h2 class="subtitle is-5 has-text-weight-bold has-text-info">Header</h2>
                    <pre><code x-text="prettyPrint(decodedHeader)"></code></pre>
                </div>
                <div class="box" x-show="decodedPayload">
                    <h2 class="subtitle is-5 has-text-weight-bold has-text-success">Payload</h2>
                    <pre><code x-text="prettyPrint(decodedPayload)"></code></pre>
                </div>
                <div class="notification is-danger" x-show="decodeError">
                    <p x-text="decodeError"></p>
                </div>
            </div>
        </div>

        <hr>

        <!-- 下方：签名验证 -->
        <div class="card">
            <header class="card-header">
                <p class="card-header-title">
                    签名验证 (Signature Verification)
                </p>
            </header>
            <div class="card-content">
                <div class="field">
                    <label for="jwksUrl" class="label">JWKS URL</label>
                    <div class="control" :class="{ 'is-loading': isFetchingJwksUrl }">
                        <input
                            id="jwksUrl"
                            class="input"
                            type="url"
                            placeholder="例如: https://www.googleapis.com/oauth2/v3/certs"
                            x-model="jwksUrl"
                        >
                    </div>
                    <p class="help is-info" x-show="isFetchingJwksUrl" x-transition>
                        正在从 Issuer 自动发现 JWKS URL...
                    </p>
                </div>
                
                <div class="field">
                    <div class="control">
                        <button
                            class="button is-primary is-fullwidth"
                            @click="verifySignature"
                            :disabled="!jwtInput || !jwksUrl || isLoading"
                            :class="{ 'is-loading': isLoading }"
                        >
                            验证签名
                        </button>
                    </div>
                </div>

                <!-- 验证结果通知 -->
                <div
                    class="notification"
                    x-show="verificationStatus.message"
                    :class="verificationStatus.type"
                    x-transition
                >
                    <button class="delete" @click="verificationStatus.message = ''"></button>
                    <p x-text="verificationStatus.message"></p>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    function jwtTools() {
        return {
            jwtInput: '',
            decodedHeader: null,
            decodedPayload: null,
            decodeError: '',
            
            jwksUrl: '',
            isFetchingJwksUrl: false, // 新增：用于显示加载状态
            isLoading: false,
            verificationStatus: {
                message: '',
                type: '' // 'is-success', 'is-danger'
            },

            prettyPrint(jsonObj) {
                if (!jsonObj) return '';
                return JSON.stringify(jsonObj, null, 2);
            },

            // ✨ --- 方法已增强 --- ✨
            async decodeJwt() {
                this.decodeError = '';
                this.decodedHeader = null;
                this.decodedPayload = null;
                this.verificationStatus.message = '';

                if (!this.jwtInput.trim()) {
                    return;
                }

                const parts = this.jwtInput.split('.');
                if (parts.length !== 3) {
                    this.decodeError = '错误：JWT 格式不正确，必须包含三个由 "." 分隔的部分。';
                    return;
                }

                try {
                    this.decodedHeader = JSON.parse(atob(parts[0].replace(/-/g, '+').replace(/_/g, '/')));
                    this.decodedPayload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));

                    // ✨ 新增：自动发现 JWKS URL
                    if (this.decodedPayload && this.decodedPayload.iss) {
                        await this.discoverJwksUrl(this.decodedPayload.iss);
                    }

                } catch (e) {
                    this.decodeError = `解码失败：${e.message}。请检查 Token 是否有效。`;
                    this.decodedHeader = null;
                    this.decodedPayload = null;
                }
            },

            // ✨ --- 新增方法：用于发现 JWKS URL --- ✨
            async discoverJwksUrl(issuer) {
                // 确保 issuer 是一个有效的 URL 前缀
                if (!issuer.startsWith('http')) {
                    console.warn('Issuer is not a valid URL, cannot discover JWKS URL.');
                    return;
                }
                
                // 去掉末尾的斜杠，以防重复
                const discoveryUrl = `${issuer.replace(/\/$/, '')}/.well-known/openid-configuration`;
                this.isFetchingJwksUrl = true;
                
                try {
                    const response = await fetch(discoveryUrl);
                    if (!response.ok) {
                        throw new Error(`Failed to fetch discovery document: ${response.statusText}`);
                    }
                    const config = await response.json();
                    if (config.jwks_uri) {
                        this.jwksUrl = config.jwks_uri;
                        console.log('Successfully discovered JWKS URL:', this.jwksUrl);
                    } else {
                        console.warn('Discovery document found, but "jwks_uri" key is missing.');
                    }
                } catch (error) {
                    // 静默失败，因为这只是一个辅助功能，用户仍然可以手动输入
                    console.error('Failed to discover JWKS URL:', error);
                } finally {
                    this.isFetchingJwksUrl = false;
                }
            },

            async verifySignature() {
                this.isLoading = true;
                this.verificationStatus = { message: '', type: '' };

                try {
                    const JWKS = jose.createRemoteJWKSet(new URL(this.jwksUrl));
                    const { payload, protectedHeader } = await jose.jwtVerify(this.jwtInput, JWKS);
                    
                    this.verificationStatus = {
                        message: '✅ 签名验证成功！Token 有效。',
                        type: 'is-success'
                    };

                } catch (error) {
                    console.error('Verification failed:', error);
                    let errorMessage = `❌ 签名验证失败: ${error.message}`;
                    if (error.code === 'ERR_JWKS_NO_MATCHING_KEY') {
                        errorMessage = '❌ 验证失败: 在提供的 JWKS URL 中找不到与此 JWT (kid) 匹配的公钥。';
                    } else if (error.code === 'ERR_JWT_SIGNATURE_VERIFICATION_FAILED') {
                        errorMessage = '❌ 验证失败: 签名不匹配，Token 可能已被篡改或使用了错误的密钥。';
                    } else if (error.code === 'ERR_JWT_EXPIRED') {
                        errorMessage = '❌ 验证失败: Token 已过期。';
                    } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        errorMessage = '❌ 网络错误: 无法获取 JWKS URL，请检查网络连接或 URL 是否正确（可能存在 CORS 跨域问题）。';
                    }

                    this.verificationStatus = {
                        message: errorMessage,
                        type: 'is-danger'
                    };
                } finally {
                    this.isLoading = false;
                }
            }
        }
    }
</script>

</body>
</html>